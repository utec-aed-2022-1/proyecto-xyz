#include <iostream>

#include "block.hpp"
#include "blockchain.hpp"
#include "catch.hpp"
#include "json.hpp"

using blocks_t = Blockchain::blocks_t;
using json = nlohmann::json;

TEST_CASE("blockchain", "[blockchain]") {
  Blockchain bs = blockchainFromFile("tests/json/blockchain1.json");

  REQUIRE(
      bs.getBlocks() ==
      blocks_t{
          {1, "Hello World", 9879,
           "0000000000000000000000000000000000000000000000000000000000000000",
           "0003D8C5719DD759F74C77AC1F32A6EBA6F202F081DDAF1DD9808D22AF8982A"
           "E"}});

  bs = blockchainFromFile("tests/json/blockchain2.json");

  REQUIRE(
      bs.getBlocks() ==
      blocks_t{
          {1, "mauri", 680,
           "0000000000000000000000000000000000000000000000000000000000000000",
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510"},
          {2, "2dsfsdfsfsdfsdfsds", 476,
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510",
           "000E588B369C95B84C27508BB34DBDCC08C3889D813EF5E416408E9A0F7E522"
           "F"}});

  bs.push("camila-prestamo: 50$");
  // This should be checked for properties instead of for a specific valid
  // value, but whateverâ€¦
  REQUIRE(
      bs.getBlocks() ==
      blocks_t{
          {1, "mauri", 680,
           "0000000000000000000000000000000000000000000000000000000000000000",
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510"},
          {2, "2dsfsdfsfsdfsdfsds", 476,
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510",
           "000E588B369C95B84C27508BB34DBDCC08C3889D813EF5E416408E9A0F7E522F"},
          {3, "camila-prestamo: 50$", 1283,
           "000E588B369C95B84C27508BB34DBDCC08C3889D813EF5E416408E9A0F7E522F",
           "00019E1549661BCF33425C23B3C47F0D275733D20B30681C931219BB9D97EF1"
           "8"}});

  bs.push("jefferson-prestamo: 10000$");
  REQUIRE(
      bs.getBlocks().back() ==
      Block{
          4, "jefferson-prestamo: 10000$", 2925,
          "00019E1549661BCF33425C23B3C47F0D275733D20B30681C931219BB9D97EF18",
          "00020C1E5C693D80F35D577A12CD7185A5700FAABDEBB78D9465A5EF0176B1A7"});

  bs.push("maria-prestamo: 1240$");
  REQUIRE(
      bs.getBlocks().back() ==
      Block{
          5, "maria-prestamo: 1240$", 1078,
          "00020C1E5C693D80F35D577A12CD7185A5700FAABDEBB78D9465A5EF0176B1A7",
          "00070737C2D76C6DD998053D7A90F591936419A8D3F4DD0B290B31AD8BCD6CE5"});

  REQUIRE(
      bs.getBlocks() ==
      blocks_t{
          {1, "mauri", 680,
           "0000000000000000000000000000000000000000000000000000000000000000",
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510"},
          {2, "2dsfsdfsfsdfsdfsds", 476,
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510",
           "000E588B369C95B84C27508BB34DBDCC08C3889D813EF5E416408E9A0F7E522F"},
          {3, "camila-prestamo: 50$", 1283,
           "000E588B369C95B84C27508BB34DBDCC08C3889D813EF5E416408E9A0F7E522F",
           "00019E1549661BCF33425C23B3C47F0D275733D20B30681C931219BB9D97EF1"
           "8"},
          {4, "jefferson-prestamo: 10000$", 2925,
           "00019E1549661BCF33425C23B3C47F0D275733D20B30681C931219BB9D97EF18",
           "00020C1E5C693D80F35D577A12CD7185A5700FAABDEBB78D9465A5EF0176B1A7"},
          {5, "maria-prestamo: 1240$", 1078,
           "00020C1E5C693D80F35D577A12CD7185A5700FAABDEBB78D9465A5EF0176B1A7",
           "00070737C2D76C6DD998053D7A90F591936419A8D3F4DD0B290B31AD8BCD6CE"
           "5"}});

  bs.edit(3, "itsme Mario aksdalda");
  REQUIRE(
      bs.getBlocks() ==
      blocks_t{
          {1, "mauri", 680,
           "0000000000000000000000000000000000000000000000000000000000000000",
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510"},
          {2, "2dsfsdfsfsdfsdfsds", 476,
           "000CCCFDD6901DEBE2DB5FF5DEBDBADB6A68EFB1BAE7B0337A372D9E36CCB510",
           "000E588B369C95B84C27508BB34DBDCC08C3889D813EF5E416408E9A0F7E522F"},
          {3, "camila-prestamo: 50$", 1283,
           "000E588B369C95B84C27508BB34DBDCC08C3889D813EF5E416408E9A0F7E522F",
           "00019E1549661BCF33425C23B3C47F0D275733D20B30681C931219BB9D97EF1"
           "8"},
          {4, "itsme Mario aksdalda", 2814,
           "00019E1549661BCF33425C23B3C47F0D275733D20B30681C931219BB9D97EF18",
           "000DFC8C76FBF4838D14E1F86DF99D8ED99351BFE295DD57771FCAEC55E6D282"},
          {5, "maria-prestamo: 1240$", 1234,
           "000DFC8C76FBF4838D14E1F86DF99D8ED99351BFE295DD57771FCAEC55E6D282",
           "0005228EC7761DFFEE6725A9C2CB6DBE9C5B21E509DF9E797558F9EA0B2116C"
           "D"}});

  REQUIRE(bs.size() == 5);
  REQUIRE(bs.find(1) == "2dsfsdfsfsdfsdfsds");
}
